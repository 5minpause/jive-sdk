<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Jive SDK Source: jive-sdk-service/lib/bootstrap.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.simplex.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Jive SDK</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-abstractDefinitions.html">abstractDefinitions</a>
						</li>
						
						<li>
							<a href="module-abstractInstances.html">abstractInstances</a>
						</li>
						
						<li>
							<a href="module-api.html">api</a>
						</li>
						
						<li>
							<a href="module-community.html">community</a>
						</li>
						
						<li>
							<a href="module-constants.html">constants</a>
						</li>
						
						<li>
							<a href="module-events.html">events</a>
						</li>
						
						<li>
							<a href="module-extstreamsInstances.html">extstreamsInstances</a>
						</li>
						
						<li>
							<a href="module-jiveutil.html">jiveutil</a>
						</li>
						
						<li>
							<a href="module-request.html">request</a>
						</li>
						
						<li>
							<a href="module-security.html">security</a>
						</li>
						
						<li>
							<a href="module-service.html">service</a>
						</li>
						
						<li>
							<a href="module-tasks.html">tasks</a>
						</li>
						
						<li>
							<a href="module-tileInstances.html">tileInstances</a>
						</li>
						
						<li>
							<a href="module-tilesDefinitions.html">tilesDefinitions</a>
						</li>
						
						<li>
							<a href="module-webhooks.html">webhooks</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="extstreamsDefinitions.html">extstreamsDefinitions</a>
						</li>
						
						<li>
							<a href="filePersistence.html">filePersistence</a>
						</li>
						
						<li>
							<a href="memoryPersistence.html">memoryPersistence</a>
						</li>
						
						<li>
							<a href="memoryScheduler.html">memoryScheduler</a>
						</li>
						
						<li>
							<a href="oauthHandler.html">oauthHandler</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: jive-sdk-service/lib/bootstrap.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">/*
 * Copyright 2013 Jive Software
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */

/**
 * @module bootstrap
 * @private
 */

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Private

var express = require('express'),
    path = require('path'),
    service = require('./service'),
    jive = require('../api'),
    consolidate = require('consolidate'),
    q = require('q'),
    extension = require('./extension/extension'),
    security = require("./security");

var alreadyBootstrapped = false;

/**
 * @param options
 */
var validateServiceOptions = function (options) {
    // options must be present
    if ( !options ) {
        throw 'Undefined options';
    }

    var errors = [];
    if ( !options['clientUrl'] ) {
        errors.push('Setup parameter clientUrl is required');
    }

    if ( errors.length > 0 ) {
        throw 'Errors were found in ' +
            ' in the configuration:\n' + errors;
    }
};

var setupExpressApp = function (app, rootDir, config) {
    if ( !app ) {
        return q.fcall(function() {
            jive.logger.warn("Warning - app not specified.");
        } );
    }

    var p1 = q.defer();
    var p2 = q.defer();

    app.configure(function () {
        app.engine('html', consolidate.mustache);
        app.set('view engine', 'html');
        app.set('views', rootDir + '/public/tiles');
        app.use(express.favicon());
        app.use(express.static(path.join(rootDir, 'public')));

        app.set('port', config['port']);

        // attach security middleware
        app.all( '*', security.checkAuthHeadersMiddleware );

        jive.logger.debug('Global framework routes:');
        app.post('/registration', service.routes.tiles.registration);
        service.security().lockRoute({ 'verb' : 'post', 'path' : '/registration' });
        app.post('/unregister', service.routes.tiles.unregister);
        service.security().lockRoute({ 'verb' : 'post', 'path' : '/unregister' });
        app.post('/jive/oauth/register', service.routes.jive.oauthRegister);

        jive.logger.debug("/registration");
        jive.logger.debug("/unregister");
        jive.logger.debug("/jive/oauth/register");

        // wire in an sdk app with its own views
        var jiveSdkApp = express();

        jiveSdkApp.engine('html js', consolidate.mustache);
        jiveSdkApp.engine('js', consolidate.mustache);
        jiveSdkApp.set('view engine', 'html js');
        jiveSdkApp.set('views', __dirname + '/../views' );    // assume that views will be in the root jive-sdk folder

        app.use( jiveSdkApp );

        // oauth2 endpoints
        jiveSdkApp.get('/javascripts/oauth2client.js', function(req, res) {
            res.render('oauth2client.js');
        });

        p1.resolve();
    });

    app.configure( 'development', function () {
        jive.logger.debug('Global dev framework routes:');

        app.get('/tiles', service.routes.dev.tiles);
        app.get('/dev/tiles', service.routes.dev.tiles);
        jive.logger.debug("/dev/tiles");

        p2.resolve();
    });

    return q.all( [ p1, p2 ] );
};

var setupScheduler = function() {
    var deferred = q.defer();

    // add base events
    jive.events.baseEvents.forEach(function(handlerInfo) {
        jive.events.addSystemEventListener(
            handlerInfo['event'],
            handlerInfo['handler'],
            handlerInfo['description']
        );
    });

    service.scheduler().init(jive.events.eventHandlerMap, service.options, jive);
    deferred.resolve();

    return deferred.promise;
};

var setupHttp = function(app, rootDir, options) {
    var deferred = q.defer();

    if ( service.role.isHttp() ) {
        jive.logger.warn('Starting service in HTTP mode');
        setupExpressApp(app, rootDir, options).then( function() {
            jive.logger.info("Http node setup");
            deferred.resolve();
        });
    } else {
        deferred.resolve();
    }

    return deferred.promise;
};

var getSDKVersion = function() {
    var sdkPackagePath = __dirname + '/../../package.json';
    return jive.util.fsexists( sdkPackagePath ).then( function(exists) {
        if ( exists ) {
            return jive.util.fsreadJson( sdkPackagePath ).then( function(packageContents) {
                if ( packageContents ) {
                    return packageContents['version'];
                } else {
                    return null;
                }
            });
        } else {
            return null;
        }
    });
};

var setupExtension = function(options, tilesDir, appsDir, cartridgesDir, storagesDir) {
    if ( options['skipCreateExtension'] ) {
        return q.resolve();
    }
    return extension.prepare('', tilesDir, appsDir, cartridgesDir, storagesDir);
};

/**
 * @param app Required.
 * @param rootDir Optional; defaults to process.cwd() if not specified
 */
exports.start = function (app, options, rootDir, tilesDir, appsDir, cartridgesDir, storagesDir) {
    if ( alreadyBootstrapped ) {
        return q.fcall( function() {
            jive.logger.warn('Already bootstrapped, skipping.');
        });
    }

    jive.logger.info("Running bootstrap.");

    // mark this already bootstrapped so we don't do it again
    alreadyBootstrapped = true;

    validateServiceOptions(options);

    return setupScheduler()
        .then( function() { return setupHttp(app, rootDir, options) })
        .then( function() { return setupExtension(options, tilesDir, appsDir, cartridgesDir, storagesDir) })
        .then( function() { return jive.util.fsexists( __dirname + '/../../package.json') })
        .then( function() { return getSDKVersion() })
        .then( function(sdkVersion) {
            jive.logger.info("Bootstrap complete.");
            if ( sdkVersion ) {
                jive.logger.info( "Jive SDK version " + sdkVersion );
            }
            jive.logger.info("Started service in ", service.options.role || 'self-contained', "mode");
            jive.events.emit("serviceBootstrapped");
            return q.resolve();
        });
};

exports.teardown = function() {
    jive.logger.info("Running teardown.");

    return service.persistence().close().then( function() {
        return service.scheduler().shutdown();
    }).then( function( ){
        // clear all events
        jive.events.reset();

        alreadyBootstrapped = false;
        jive.logger.info("Teardown complete.");
        return q.resolve();
    });
};
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Jive Software, Inc
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-dev</a>
		on Tue Dec 31 2013 15:31:56 GMT-0800 (PST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
